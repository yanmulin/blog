<!DOCTYPE html>
<html lang="en">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <meta charset="utf-8">

  
  <title>Unixè¿·å¤±çš„å”¤é†’</title>
  
  <link rel="canonical" href="https://yanmulin.me/2020/12/14/synUTS/">
  
  <meta name="description" content="è¿™ç¯‡è®ºæ–‡ä»‹ç»äº†Unixå†…æ ¸å¦‚ä½•ä¸ºå¤šæ ¸å¤„ç†å™¨è®¾è®¡çš„è®¾è®¡åŸºäºäº‹ä»¶çš„sleep lockï¼Œå¹¶åˆ©ç”¨è‡ªæ—‹é”è§£å†³å”¤é†’æ—¶çš„ç«äº‰é—®é¢˜ã€‚è¿™ç¯‡è®ºæ–‡åˆ†æäº†å†…æ ¸ä¸­è®¸å¤šæ½œåœ¨ç«äº‰é—®é¢˜ï¼Œç»“åˆModel Checkingå’ŒSpinï¼Œååˆ†å€¼å¾—ç¢ç£¨ä¸”æœ‰è¶£ã€‚ Sleep Lock ä¸å”¤é†’ç«äº‰é”çš„è·å–ä¸é‡Šæ”¾åœ¨Unixå†…æ ¸ä¸­è¢«å½“ä½œäº‹ä»¶å¤„ç†ï¼š">
  
  
  <meta name="author" content="yanmulin">
  <meta property="og:site_name" content="é¢œæœ¨æ—çš„æµæ°´è´¦" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Unixè¿·å¤±çš„å”¤é†’" />
  
  <meta property="og:description" content="è¿™ç¯‡è®ºæ–‡ä»‹ç»äº†Unixå†…æ ¸å¦‚ä½•ä¸ºå¤šæ ¸å¤„ç†å™¨è®¾è®¡çš„è®¾è®¡åŸºäºäº‹ä»¶çš„sleep lockï¼Œå¹¶åˆ©ç”¨è‡ªæ—‹é”è§£å†³å”¤é†’æ—¶çš„ç«äº‰é—®é¢˜ã€‚è¿™ç¯‡è®ºæ–‡åˆ†æäº†å†…æ ¸ä¸­è®¸å¤šæ½œåœ¨ç«äº‰é—®é¢˜ï¼Œç»“åˆModel Checkingå’ŒSpinï¼Œååˆ†å€¼å¾—ç¢ç£¨ä¸”æœ‰è¶£ã€‚ Sleep Lock ä¸å”¤é†’ç«äº‰é”çš„è·å–ä¸é‡Šæ”¾åœ¨Unixå†…æ ¸ä¸­è¢«å½“ä½œäº‹ä»¶å¤„ç†ï¼š">
  
  <meta property="og:url" content="https://yanmulin.me/2020/12/14/synUTS/" />

  <!-- Mobile Specific Metas
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <link rel="preload" href="../fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="../fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  

  <!-- Favicon
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <link rel="icon" type="image/png" href="/images/favicon.png">

  <!-- Custom Theme Color Style
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  <style>
  a:not(.icon) {
    text-decoration-color: #0FA0CE;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #0FA0CE 50%
    );
  }
  .category-link {]
    text-decoration-color: transparent;
    border-color: #0FA0CE;
  }
  blockquote {
    border-left: 8px solid #0FA0CE;
  }
  .nanobar .bar {
    background: #0FA0CE;
  }
  .post-body h3::before {
    color: #0FA0CE;
  } 
  .post-body h4::before {
    color: #0FA0CE;
  } 
  .post-body h5::before {
    color: #0FA0CE;
  } 
  .post-body h6::before {
    color: #0FA0CE;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #0FA0CE;
    border-color: #0FA0CE;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #0FA0CE;
  }
</style>

  <!-- Google Analytics (With Privacy Settings On)
  â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ -->
  

<meta name="generator" content="Hexo 5.2.0"></head>

<body class="darkmode">
  <div class="container">
    <div class="row">
      <div>
        <div class="row">
  

  <div class="twelve columns">
    <div class="row" style="margin-bottom: 2.6rem">
        
          
            
              <a href="/archives" class="mr u-pull-right">Notes</a>
            
          
            
              <a href="/About" class="mr u-pull-right">About</a>
            
          
          <a href="/" class="u-pull-right mr">Home</a>
        
      </div>
  </div>

  
    <h2>Unixè¿·å¤±çš„å”¤é†’</h2>
    <p class="post-info">Dec 14, 2020 <a class="category-link" href="/categories/unclassified/">unclassified</a></p>
  
</div>

        <div class="trans">
          <div class="post-body">
  
  <p><a target="_blank" rel="noopener" href="https://www.usenix.org/legacy/publications/compsystems/1990/sum_ruane.pdf">è¿™ç¯‡è®ºæ–‡</a>ä»‹ç»äº†Unixå†…æ ¸å¦‚ä½•ä¸ºå¤šæ ¸å¤„ç†å™¨è®¾è®¡çš„è®¾è®¡åŸºäºäº‹ä»¶çš„sleep lockï¼Œå¹¶åˆ©ç”¨è‡ªæ—‹é”è§£å†³å”¤é†’æ—¶çš„ç«äº‰é—®é¢˜ã€‚è¿™ç¯‡è®ºæ–‡åˆ†æäº†å†…æ ¸ä¸­è®¸å¤šæ½œåœ¨ç«äº‰é—®é¢˜ï¼Œç»“åˆModel Checkingå’ŒSpinï¼Œååˆ†å€¼å¾—ç¢ç£¨ä¸”æœ‰è¶£ã€‚</p>
<h3 id="Sleep-Lock-ä¸å”¤é†’ç«äº‰"><a href="#Sleep-Lock-ä¸å”¤é†’ç«äº‰" class="headerlink" title="Sleep Lock ä¸å”¤é†’ç«äº‰"></a>Sleep Lock ä¸å”¤é†’ç«äº‰</h3><p>é”çš„è·å–ä¸é‡Šæ”¾åœ¨Unixå†…æ ¸ä¸­è¢«å½“ä½œäº‹ä»¶å¤„ç†ï¼šè·å–é”æ—¶ï¼Œè¿›ç¨‹æ£€æŸ¥èµ„æºå ç”¨æƒ…å†µï¼Œå¦‚æœå·²è¢«å ç”¨ï¼Œåˆ™æŠŠè¿›ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ¥ç€ç¡çœ ç­‰å¾…ï¼›é‡Šæ”¾é”æ—¶ï¼ŒæŠŠæ‰€æœ‰ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹å”¤é†’ï¼Œä»¤ä»–ä»¬äº‰å¤ºèµ„æºï¼Œåªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥äº‰å¤ºåˆ°èµ„æºï¼Œäºæ˜¯å…¶ä»–è¿›ç¨‹ç»§ç»­ç¡çœ ç­‰å¾…ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process A</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>lock<span class="token punctuation">)</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process B</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">wakeup</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªç«äº‰é—®é¢˜ã€‚å‡è®¾åˆå§‹ç”±è¿›ç¨‹Bå ç”¨<code>r-&gt;lock</code>ï¼Œå½“è¿›ç¨‹Aè¿è¡Œåˆ°ç¬¬2-3è¡Œé—´ï¼Œå®šæ—¶å™¨ä¸­æ–­æ¥ä¸´ï¼Œåˆ‡æ¢åˆ°è¿›ç¨‹Bè¿è¡Œã€‚æ¥ç€è¿›ç¨‹Bé‡Šæ”¾é”<code>r-&gt;lock = 0</code>ï¼Œæ‰§è¡Œå”¤é†’<code>wakeup</code>ï¼Œä½†è¿™æ—¶è¿›ç¨‹Aè¿˜æ²¡æœ‰ç¡çœ ã€‚ç­‰è½®åˆ°è¿›ç¨‹Aè¿è¡Œå¹¶é™·å…¥ç¡çœ æ—¶ï¼Œè¿›ç¨‹Aå·²ç»æ²¡æœ‰æœºä¼šå†è¢«å”¤é†’äº†ã€‚è¿™é‡Œäº§ç”Ÿçš„å”¤é†’ç«äº‰ï¼Œæ˜¯æœ¬æ–‡è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚</p>
<h3 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h3><p>ç”±äºç«äº‰äº§ç”Ÿçš„æ ¹æºæ˜¯ä¸­æ–­å¯¼è‡´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç¦ç”¨ä¸­æ–­è‡³å°‘å¯ä»¥ä¸ºå•æ ¸å¤„ç†å™¨è§£å†³é—®é¢˜ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process A</span>
<span class="token function">interruption_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>lock<span class="token punctuation">)</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">interruption_endable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process B</span>
<span class="token function">interruption_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">wakeup</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">interruption_endable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å°½ç®¡ç¦ç”¨äº†ä¸­æ–­ï¼Œå¹¶å‘åœ¨å¤šæ ¸å¤„ç†å™¨ä»ç„¶å­˜åœ¨ã€‚è¿™é‡Œå¼•å…¥è‡ªæ—‹é”è§£å†³é—®é¢˜ã€‚è‡ªæ—‹é”å¯ä»¥æä¾›å¤„ç†å™¨çº§åˆ«çš„åŒæ­¥ï¼Œç”¨äºçŸ­æœŸçš„äº’æ–¥è®¿é—®ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process A</span>
<span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>lock<span class="token punctuation">)</span>
  <span class="token function">sleepl</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token operator">&amp;&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">freelock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process B</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">waitlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">wakeup</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œ<code>waitlock</code>åªç­‰å¾…è‡ªæ—‹é”è¢«é‡Šæ”¾ï¼Œè€Œä¸è·å–é”ã€‚ä½¿ç”¨<code>waitlock</code>è€Œé<code>spinlock</code>å¯ä»¥å‡å°‘äº‰å¤ºé”å¸¦æ¥çš„æ€§èƒ½ä¸‹é™ã€‚è¿›ç¨‹Båœ¨é‡Šæ”¾<code>r-&gt;lock</code>åç­‰å¾…è‡ªæ—‹é”çš„é‡Šæ”¾ï¼Œç¡®ä¿è¿›ç¨‹Aè¦ä¹ˆé™·å…¥ç¡çœ çŠ¶æ€ï¼Œè¦ä¹ˆè·³è¿‡<code>while</code>å¾ªç¯ã€‚ç¡çœ çŠ¶æ€çš„è¿›ç¨‹ä¸èƒ½æŒæœ‰è‡ªæ—‹é”ï¼Œæ‰€ä»¥è‡ªæ—‹é”è¢«ä¼ å…¥<code>sleepl</code>ï¼Œé™·å…¥ç¡çœ å‰é‡Šæ”¾ï¼Œè¢«å”¤é†’åé‡æ–°è·å–ã€‚</p>
<h3 id="å¼•å…¥wantå‡å°‘å”¤é†’æ¬¡æ•°"><a href="#å¼•å…¥wantå‡å°‘å”¤é†’æ¬¡æ•°" class="headerlink" title="å¼•å…¥wantå‡å°‘å”¤é†’æ¬¡æ•°"></a>å¼•å…¥wantå‡å°‘å”¤é†’æ¬¡æ•°</h3><p><code>wakeup</code>å®é™…ä¸Šå°†æ‰€æœ‰ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹å”¤é†’ï¼Œå¸¦æ¥å¾ˆå¤§çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œå¼•å…¥ä¸€ä¸ª<code>want</code>å˜é‡é¿å…ä¸å¿…è¦çš„å”¤é†’ã€‚ä½†æ˜¯ä¹Ÿå¼•å…¥äº†æ–°çš„ç«äº‰é—®é¢˜ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process A</span>
<span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  r<span class="token operator">-></span>want <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">sleepl</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">freelock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Process B</span>
r<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">waitlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-></span>want<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  r<span class="token operator">-></span>want <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">waitlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">wakeup</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸€å®šéœ€è¦ä¸¤ä¸ª<code>waitlock</code>ï¼Œç¬¬ä¸€ä¸ªç”¨äºä¿æŠ¤<code>want</code>å¿…é¡»åœ¨æµ‹è¯•å‰è¢«ç½®ä¸€ï¼Œç¬¬äºŒä¸ªç¡®ä¿ä¸å­˜åœ¨å”¤é†’ç«äº‰ã€‚ä¸€ä¸ªæœ‰ç‚¹éš¾çš„é—®é¢˜ï¼šå¦‚æœä¸å­˜åœ¨ç¬¬äºŒä¸ª<code>waitlock</code>ï¼Œç«äº‰å¦‚ä½•è§¦å‘ï¼Ÿå‡è®¾è¿›ç¨‹Aåˆšåˆšè¢«å”¤é†’ï¼Œè€Œè¿›ç¨‹Bæ­£åœ¨é‡Šæ”¾èµ„æºã€‚ç”±äºè¿›ç¨‹Aè¿˜æ²¡å°è¯•è·å¾—è‡ªæ—‹é”ï¼Œè¿›ç¨‹Båœ¨ç¬¬ä¸€ä¸ª<code>waitlock</code>æ²¡æœ‰é‡åˆ°éšœç¢å¹¶é€šè¿‡äº†<code>r-&gt;want</code>çš„æµ‹è¯•ï¼ˆå…¶ä»–è¿›ç¨‹è®¾ç½®äº†<code>r-&gt;want</code>ï¼‰ã€‚æ¥ç€è¿›ç¨‹Aä»<code>sleepl</code>è¿”å›ï¼Œæµ‹è¯•<code>r-&gt;lock</code>ï¼Œå¯èµ„æºå·²ç»è¢«å…¶ä»–è¿›ç¨‹æŠ¢èµ°ï¼Œäºæ˜¯è¿›ç¨‹Aé‡æ–°è¿›å…¥ç¡çœ ã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ç¬¬äºŒä¸ª<code>waitlock</code>ï¼Œå”¤é†’ç«äº‰ä»ç„¶å­˜åœ¨ã€‚</p>
<h3 id="æ¡ä»¶è·å–Sleep-Lock"><a href="#æ¡ä»¶è·å–Sleep-Lock" class="headerlink" title="æ¡ä»¶è·å–Sleep Lock"></a>æ¡ä»¶è·å–Sleep Lock</h3><p>Unixå†…æ ¸ä¸­æœ‰è¿™æ ·çš„æƒ…å†µï¼šå°½ç®¡è¿›ç¨‹æŠ¢åˆ°äº†é”ï¼Œå®ƒä¹Ÿä¸ä¸€å®šè·å–è¿™ä¸ªé”ã€‚æ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿçš„ç©ºé—²å—ï¼Œä»¥é“¾è¡¨çš„å½¢å¼å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚è¿›ç¨‹åªåœ¨é“¾è¡¨æ»¡çš„æ—¶å€™æ‰çœŸæ­£è·å–ä¿æŠ¤é“¾è¡¨çš„é”ã€‚è¿™ä¸ªä¾‹å­ä¸­ï¼Œè‡ªæ—‹é”è¿˜ä¿æŠ¤é“¾è¡¨çš„æ“ä½œã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>lock<span class="token punctuation">)</span>
  <span class="token function">sleepl</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isfull</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>free<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  fp<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">freelock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  write fp<span class="token operator">-></span>free into disk
  set fp<span class="token operator">-></span>free to empty
  <span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">wakeup</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
append block being freed to fp<span class="token operator">-></span>free
<span class="token function">freelock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯ä»¥è€ƒè™‘ä¸‹é¢çš„å”¤é†’å®ç°ä¸ºä»€ä¹ˆä¸å¯è¡Œã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">fp<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token operator">-></span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">wakeup</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åˆ©ç”¨Spinå¯ä»¥éªŒè¯ï¼Œè¿™ä¸ªå”¤é†’å®ç°çš„é—®é¢˜åœ¨äºå¯èƒ½å¯¼è‡´é“¾è¡¨æº¢å‡ºã€‚æ¯”å¦‚è¿›ç¨‹åœ¨é‡Šæ”¾<code>fp-&gt;lock</code>åè¢«æ‰“æ–­ï¼Œé“¾è¡¨è¢«å¡«æ»¡ï¼Œç„¶åè¿›ç¨‹æ¢å¤å¹¶ç»§ç»­è¿è¡Œåˆ°13è¡Œï¼Œå¯¼è‡´é“¾è¡¨æº¢å‡ºã€‚</p>
<p>è¿™é‡ŒåŒæ ·å¯ä»¥å¼•å…¥<code>want</code>å˜é‡å‡å°‘å”¤é†’æ¬¡æ•°ã€‚</p>
<h3 id="è·¨è¿›ç¨‹æ¶ˆæ¯é˜Ÿåˆ—çš„Sleep-Lock"><a href="#è·¨è¿›ç¨‹æ¶ˆæ¯é˜Ÿåˆ—çš„Sleep-Lock" class="headerlink" title="è·¨è¿›ç¨‹æ¶ˆæ¯é˜Ÿåˆ—çš„Sleep Lock"></a>è·¨è¿›ç¨‹æ¶ˆæ¯é˜Ÿåˆ—çš„Sleep Lock</h3><p>æ¶ˆæ¯é˜Ÿåˆ—æœ‰ä¸‰ä¸ªé”ï¼šé˜Ÿåˆ—é”ï¼Œæ¶ˆæ¯é”å’Œè‡ªæ—‹é”ã€‚é˜Ÿåˆ—é”ç”¨äºæ“ä½œé˜Ÿåˆ—ï¼Œæ¶ˆæ¯é”ç”¨äºæ¶ˆè´¹è€…ç­‰å¾…ç©ºé˜Ÿåˆ—ï¼Œè‡ªæ—‹é”ç”¨äºä¿éšœå¤„ç†å™¨çº§åˆ«çš„åŒæ­¥ã€‚å…¶ä¸­è‡ªæ—‹é”æ˜¯IPCå…¨å±€å…±äº«çš„ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Sender</span>
<span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>qp<span class="token operator">-></span>lock<span class="token punctuation">)</span>
  <span class="token function">sleepl</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
qp<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">freelock</span><span class="token punctuation">(</span>qp<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Enqueue a message */</span>
<span class="token function">wakeup</span><span class="token punctuation">(</span>qp<span class="token operator">-></span>qnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
qp<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">waitlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">wakeup</span><span class="token punctuation">(</span>qp<span class="token operator">-></span>qnum<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Receiver</span>
loop<span class="token operator">:</span>
<span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>qp<span class="token operator">-></span>lock<span class="token punctuation">)</span>
  <span class="token function">sleepl</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
qp<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">freelock</span><span class="token punctuation">(</span>qp<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* if no message to read */</span>
<span class="token function">spinlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
qp<span class="token operator">-></span>lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">wakeup</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sleepl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>qp<span class="token operator">-></span>qnum<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">freelock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg_lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">goto</span> loop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¦–å…ˆï¼ŒReceiverè¦ç¡®ä¿åœ¨é‡Šæ”¾<code>qp-&gt;lock</code>å‰è·å–è‡ªæ—‹é”ï¼Œå¦åˆ™<code>sleepl(&amp;qp-&gt;qnum, &amp;msg_lk)</code>å¯¹åº”çš„å”¤é†’å¯èƒ½ä¸¢å¤±ã€‚å…¶æ¬¡ï¼Œ<code>wakeup(qp-&gt;qnum)</code>å‰é¢ä¸éœ€è¦ç­‰å¾…è‡ªæ—‹é”ï¼Œå› ä¸ºæ­¤æ—¶Senderå·²ç»æ‹¥æœ‰<code>qp-&gt;lock</code>ï¼ŒReceiverè¦ä¹ˆæ­£åœ¨ç­‰å¾…<code>qp-&gt;qnum</code>ï¼Œè¦ä¹ˆæ­£åœ¨ç­‰å¾…<code>qp-&gt;lock</code>ï¼Œä¸å¯èƒ½äº§ç”Ÿå”¤é†’ç«äº‰ã€‚</p>
<h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>é€šè¿‡å‡ ä¸ªå”¤é†’ç«äº‰çš„ä¾‹å­ï¼Œå¯ä»¥ä¸€çª¥å¹¶å‘ç¼–ç¨‹ä¸ç«äº‰åˆ†æçš„éš¾ç‚¹ã€‚æ­£å¦‚ä¿¡æ¯å®‰å…¨å­¦ï¼ŒåŸè¯­å¹¶ä¸èƒ½ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚ç¨‹åºçš„çº¿ç¨‹å®‰å…¨éšæ‚£ï¼Œå¾€å¾€åœ¨äºéå¸¸éšè”½ä¸”å¾®å¦™çš„åœ°æ–¹ã€‚</p>

  
  

</div>

          
<footer>
  <span className='cc-licence'>CC BY-NC-SA 4.0</span> Â© 2020 ğŸ£
</footer>


        </div>
      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>
  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>
